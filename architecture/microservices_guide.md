# ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å®Œå…¨ã‚¬ã‚¤ãƒ‰

## ç›®æ¬¡
- [ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã¨ã¯](#ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã¨ã¯)
- [ã‚µãƒ¼ãƒ“ã‚¹åˆ†å‰²](#ã‚µãƒ¼ãƒ“ã‚¹åˆ†å‰²)
- [é€šä¿¡ãƒ‘ã‚¿ãƒ¼ãƒ³](#é€šä¿¡ãƒ‘ã‚¿ãƒ¼ãƒ³)
- [API Gateway](#api-gateway)
- [ãƒ‡ãƒ¼ã‚¿ç®¡ç†](#ãƒ‡ãƒ¼ã‚¿ç®¡ç†)
- [ãƒ‡ãƒ—ãƒ­ã‚¤æˆ¦ç•¥](#ãƒ‡ãƒ—ãƒ­ã‚¤æˆ¦ç•¥)
- [ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°](#ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°)
- [èª²é¡Œã¨å¯¾ç­–](#èª²é¡Œã¨å¯¾ç­–)

---

## ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã¨ã¯

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å°ã•ãªç‹¬ç«‹ã—ãŸã‚µãƒ¼ãƒ“ã‚¹ã®é›†åˆã¨ã—ã¦æ§‹ç¯‰ã™ã‚‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚¹ã‚¿ã‚¤ãƒ«ã€‚

### ç‰¹å¾´

- ğŸ¯ å˜ä¸€è²¬ä»»: å„ã‚µãƒ¼ãƒ“ã‚¹ã¯1ã¤ã®ãƒ“ã‚¸ãƒã‚¹æ©Ÿèƒ½ã«é›†ä¸­
- ğŸ”„ ç‹¬ç«‹ãƒ‡ãƒ—ãƒ­ã‚¤: ã‚µãƒ¼ãƒ“ã‚¹ã”ã¨ã«ç‹¬ç«‹ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤å¯èƒ½
- ğŸ› ï¸ æŠ€è¡“å¤šæ§˜æ€§: ã‚µãƒ¼ãƒ“ã‚¹ã”ã¨ã«æœ€é©ãªæŠ€è¡“ã‚’é¸æŠå¯èƒ½
- ğŸ“¦ ç–çµåˆ: ã‚µãƒ¼ãƒ“ã‚¹é–“ã®ä¾å­˜ã‚’æœ€å°åŒ–
- ğŸ”€ åˆ†æ•£ã‚·ã‚¹ãƒ†ãƒ : ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¶Šã—ã«é€šä¿¡

### ãƒ¡ãƒªãƒƒãƒˆ

```
âœ“ ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£: å¿…è¦ãªã‚µãƒ¼ãƒ“ã‚¹ã®ã¿ã‚¹ã‚±ãƒ¼ãƒ«
âœ“ é–‹ç™ºé€Ÿåº¦: ãƒãƒ¼ãƒ ç‹¬ç«‹ã€ä¸¦è¡Œé–‹ç™ºå¯èƒ½
âœ“ éšœå®³åˆ†é›¢: 1ã‚µãƒ¼ãƒ“ã‚¹ã®éšœå®³ãŒå…¨ä½“ã«æ³¢åŠã—ãªã„
âœ“ æŠ€è¡“é¸æŠã®è‡ªç”±: ã‚µãƒ¼ãƒ“ã‚¹ã”ã¨ã«æœ€é©ãªæŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯
âœ“ æ®µéšçš„ãƒªãƒ—ãƒ¬ãƒ¼ã‚¹: éƒ¨åˆ†çš„ãªæ›¸ãæ›ãˆãŒå¯èƒ½
```

### ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ

```
âœ— è¤‡é›‘æ€§å¢—åŠ : åˆ†æ•£ã‚·ã‚¹ãƒ†ãƒ ã®è¤‡é›‘ã•
âœ— ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†ãŒå›°é›£
âœ— ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é…å»¶: ã‚µãƒ¼ãƒ“ã‚¹é–“é€šä¿¡ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰
âœ— ãƒ‡ãƒãƒƒã‚°å›°é›£: è¤‡æ•°ã‚µãƒ¼ãƒ“ã‚¹ã«ã¾ãŸãŒã‚‹å•é¡Œã®è¿½è·¡
âœ— é‹ç”¨ã‚³ã‚¹ãƒˆ: ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ»ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã®è¤‡é›‘åŒ–
```

---

## ã‚µãƒ¼ãƒ“ã‚¹åˆ†å‰²

### ãƒ‰ãƒ¡ã‚¤ãƒ³é§†å‹•è¨­è¨ˆã«ã‚ˆã‚‹åˆ†å‰²

```
å¢ƒç•Œã¥ã‘ã‚‰ã‚ŒãŸã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆBounded Contextï¼‰ã‚’åŸºæº–ã«åˆ†å‰²

ä¾‹: ECã‚µã‚¤ãƒˆ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User       â”‚  â”‚  Product    â”‚  â”‚  Order      â”‚
â”‚  Service    â”‚  â”‚  Service    â”‚  â”‚  Service    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - èªè¨¼      â”‚  â”‚ - å•†å“ç®¡ç†  â”‚  â”‚ - æ³¨æ–‡å‡¦ç†  â”‚
â”‚ - ãƒ—ãƒ­ãƒ•ã‚£  â”‚  â”‚ - åœ¨åº«ç®¡ç†  â”‚  â”‚ - æ±ºæ¸ˆ      â”‚
â”‚ - æ¨©é™      â”‚  â”‚ - ã‚«ãƒ†ã‚´ãƒª  â”‚  â”‚ - é…é€      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ“ã‚¸ãƒã‚¹æ©Ÿèƒ½ã«ã‚ˆã‚‹åˆ†å‰²

```typescript
// ã‚µãƒ¼ãƒ“ã‚¹ä¾‹
- User Service: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†
- Product Service: å•†å“ç®¡ç†
- Order Service: æ³¨æ–‡å‡¦ç†
- Payment Service: æ±ºæ¸ˆå‡¦ç†
- Notification Service: é€šçŸ¥
- Search Service: æ¤œç´¢
- Recommendation Service: ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‰
```

### åˆ†å‰²ã®åŸå‰‡

```
1. å˜ä¸€è²¬ä»»ã®åŸå‰‡
   å„ã‚µãƒ¼ãƒ“ã‚¹ã¯1ã¤ã®ãƒ“ã‚¸ãƒã‚¹æ©Ÿèƒ½ã«é›†ä¸­

2. è‡ªå¾‹æ€§
   ä»–ã‚µãƒ¼ãƒ“ã‚¹ã«ä¾å­˜ã›ãšå‹•ä½œå¯èƒ½

3. ãƒ‰ãƒ¡ã‚¤ãƒ³çŸ¥è­˜ã®ã‚«ãƒ—ã‚»ãƒ«åŒ–
   ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã‚µãƒ¼ãƒ“ã‚¹å†…ã«é–‰ã˜è¾¼ã‚ã‚‹

4. ãƒ‡ãƒ¼ã‚¿ã®æ‰€æœ‰æ¨©
   å„ã‚µãƒ¼ãƒ“ã‚¹ãŒè‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ‰€æœ‰ãƒ»ç®¡ç†

5. APIãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ
   æ˜ç¢ºãªã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã§é€šä¿¡
```

### ã‚µãƒ¼ãƒ“ã‚¹ã‚µã‚¤ã‚º

```
Two Pizza Team Rule (Amazon):
- 2æšã®ãƒ”ã‚¶ã§é¤Šãˆã‚‹ãƒãƒ¼ãƒ ã‚µã‚¤ã‚º (5-8äºº)
- ã‚µãƒ¼ãƒ“ã‚¹ã¯ã“ã®ãƒãƒ¼ãƒ ã§ç®¡ç†ã§ãã‚‹ã‚µã‚¤ã‚º

å®Ÿè£…è¦æ¨¡:
- Small: æ•°ç™¾ã€œæ•°åƒè¡Œ
- Medium: æ•°åƒã€œ1ä¸‡è¡Œ
- Large: 1ä¸‡è¡Œä»¥ä¸Šï¼ˆå¤§ãã™ãã‚‹å ´åˆã¯åˆ†å‰²æ¤œè¨ï¼‰
```

---

## é€šä¿¡ãƒ‘ã‚¿ãƒ¼ãƒ³

### åŒæœŸé€šä¿¡ï¼ˆREST APIï¼‰

```typescript
// User Service â†’ Order Service
import axios from 'axios'

async function createOrder(userId: string, items: CartItem[]) {
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—
  const user = await axios.get(`http://user-service/users/${userId}`)

  // åœ¨åº«ç¢ºèª
  const inventory = await axios.post('http://product-service/inventory/check', {
    items
  })

  if (!inventory.available) {
    throw new Error('åœ¨åº«ä¸è¶³')
  }

  // æ³¨æ–‡ä½œæˆ
  const order = await axios.post('http://order-service/orders', {
    userId,
    items,
    user: user.data
  })

  return order.data
}
```

### éåŒæœŸé€šä¿¡ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°ï¼‰

```typescript
// Order Service: ã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œ
import { publishEvent } from './message-broker'

async function createOrder(data: OrderData) {
  const order = await db.orders.create(data)

  // ã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œ
  await publishEvent('order.created', {
    orderId: order.id,
    userId: order.userId,
    items: order.items,
    total: order.total
  })

  return order
}

// Payment Service: ã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­
import { subscribeToEvent } from './message-broker'

subscribeToEvent('order.created', async (event) => {
  const { orderId, total } = event.data

  // æ±ºæ¸ˆå‡¦ç†
  await processPayment(orderId, total)

  // å®Œäº†ã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œ
  await publishEvent('payment.completed', { orderId })
})

// Notification Service: ã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­
subscribeToEvent('payment.completed', async (event) => {
  const { orderId } = event.data

  // é€šçŸ¥é€ä¿¡
  await sendNotification(orderId)
})
```

### gRPC

```protobuf
// user.proto
syntax = "proto3";

service UserService {
  rpc GetUser (GetUserRequest) returns (User);
  rpc CreateUser (CreateUserRequest) returns (User);
}

message GetUserRequest {
  string user_id = 1;
}

message User {
  string id = 1;
  string name = 2;
  string email = 3;
}
```

```typescript
// ã‚µãƒ¼ãƒãƒ¼å´
import { Server, ServerCredentials } from '@grpc/grpc-js'

const server = new Server()

server.addService(UserServiceService, {
  getUser: async (call, callback) => {
    const user = await db.users.findById(call.request.user_id)
    callback(null, user)
  }
})

server.bindAsync('0.0.0.0:50051', ServerCredentials.createInsecure(), () => {
  server.start()
})

// ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´
import { UserServiceClient } from './generated/user_grpc_pb'

const client = new UserServiceClient('localhost:50051', grpc.credentials.createInsecure())

client.getUser({ user_id: '123' }, (err, response) => {
  console.log(response.toObject())
})
```

---

## API Gateway

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹é–“ã®å˜ä¸€ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã€‚

### å½¹å‰²

```
1. ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
   ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é©åˆ‡ãªã‚µãƒ¼ãƒ“ã‚¹ã«è»¢é€

2. èªè¨¼ãƒ»èªå¯
   çµ±ä¸€çš„ãªèªè¨¼å‡¦ç†

3. ãƒ¬ãƒ¼ãƒˆåˆ¶é™
   APIå‘¼ã³å‡ºã—ã®åˆ¶å¾¡

4. ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°
   è¤‡æ•°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¸ã®è² è·åˆ†æ•£

5. ãƒ¬ã‚¹ãƒãƒ³ã‚¹é›†ç´„
   è¤‡æ•°ã‚µãƒ¼ãƒ“ã‚¹ã®çµæœã‚’é›†ç´„

6. ãƒ—ãƒ­ãƒˆã‚³ãƒ«å¤‰æ›
   HTTP â†’ gRPCç­‰ã®å¤‰æ›
```

### å®Ÿè£…ä¾‹ï¼ˆExpress + http-proxy-middlewareï¼‰

```typescript
import express from 'express'
import { createProxyMiddleware } from 'http-proxy-middleware'
import jwt from 'jsonwebtoken'

const app = express()

// èªè¨¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
const authenticate = (req, res, next) => {
  const token = req.headers.authorization?.split(' ')[1]

  if (!token) {
    return res.status(401).json({ error: 'Unauthorized' })
  }

  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET!)
    req.user = decoded
    next()
  } catch (error) {
    res.status(401).json({ error: 'Invalid token' })
  }
}

// User Service
app.use('/api/users', authenticate, createProxyMiddleware({
  target: 'http://user-service:3001',
  changeOrigin: true,
  pathRewrite: { '^/api/users': '' }
}))

// Product Service
app.use('/api/products', createProxyMiddleware({
  target: 'http://product-service:3002',
  changeOrigin: true,
  pathRewrite: { '^/api/products': '' }
}))

// Order Service
app.use('/api/orders', authenticate, createProxyMiddleware({
  target: 'http://order-service:3003',
  changeOrigin: true,
  pathRewrite: { '^/api/orders': '' }
}))

app.listen(3000)
```

### Kong / Nginx

```nginx
# nginx.conf
upstream user_service {
  server user-service:3001;
}

upstream product_service {
  server product-service:3002;
}

server {
  listen 80;

  location /api/users {
    proxy_pass http://user_service;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
  }

  location /api/products {
    proxy_pass http://product_service;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
  }
}
```

---

## ãƒ‡ãƒ¼ã‚¿ç®¡ç†

### Database per Service

å„ã‚µãƒ¼ãƒ“ã‚¹ãŒå°‚ç”¨ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æŒã¤ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User        â”‚  â”‚ Product     â”‚  â”‚ Order       â”‚
â”‚ Service     â”‚  â”‚ Service     â”‚  â”‚ Service     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                â”‚                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚ User DB     â”‚  â”‚ Product DB  â”‚  â”‚ Order DB    â”‚
â”‚ (PostgreSQL)â”‚  â”‚ (PostgreSQL)â”‚  â”‚ (MongoDB)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Saga ãƒ‘ã‚¿ãƒ¼ãƒ³

åˆ†æ•£ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®ç®¡ç†ã€‚

```typescript
// Orchestration-based Saga
class OrderSagaOrchestrator {
  async createOrder(orderData: OrderData) {
    const sagaId = generateId()

    try {
      // Step 1: æ³¨æ–‡ä½œæˆ
      const order = await orderService.createOrder(sagaId, orderData)

      // Step 2: åœ¨åº«ç¢ºä¿
      await inventoryService.reserve(sagaId, order.items)

      // Step 3: æ±ºæ¸ˆå‡¦ç†
      await paymentService.charge(sagaId, order.total)

      // Step 4: é…é€æ‰‹é…
      await shippingService.arrange(sagaId, order.id)

      // æˆåŠŸ
      await orderService.confirmOrder(order.id)

    } catch (error) {
      // è£œå„Ÿãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
      await this.compensate(sagaId, error)
      throw error
    }
  }

  async compensate(sagaId: string, error: Error) {
    // é€†é †ã§ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
    await shippingService.cancel(sagaId)
    await paymentService.refund(sagaId)
    await inventoryService.release(sagaId)
    await orderService.cancelOrder(sagaId)
  }
}
```

### Event Sourcing

ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨˜éŒ²ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å†æ§‹ç¯‰ã€‚

```typescript
// ã‚¤ãƒ™ãƒ³ãƒˆå®šç¾©
interface OrderEvent {
  eventId: string
  orderId: string
  type: string
  timestamp: Date
  data: any
}

// ã‚¤ãƒ™ãƒ³ãƒˆä¿å­˜
class OrderEventStore {
  async appendEvent(event: OrderEvent) {
    await db.events.insert(event)
    await this.publishEvent(event)
  }

  async getEvents(orderId: string): Promise<OrderEvent[]> {
    return await db.events.find({ orderId }).sort({ timestamp: 1 })
  }
}

// çŠ¶æ…‹å†æ§‹ç¯‰
class OrderProjection {
  async getOrderState(orderId: string) {
    const events = await eventStore.getEvents(orderId)

    let state = { status: 'pending', items: [], total: 0 }

    for (const event of events) {
      state = this.applyEvent(state, event)
    }

    return state
  }

  applyEvent(state: any, event: OrderEvent) {
    switch (event.type) {
      case 'OrderCreated':
        return { ...state, ...event.data }
      case 'PaymentCompleted':
        return { ...state, status: 'paid' }
      case 'OrderShipped':
        return { ...state, status: 'shipped' }
      default:
        return state
    }
  }
}
```

---

## ãƒ‡ãƒ—ãƒ­ã‚¤æˆ¦ç•¥

### ã‚³ãƒ³ãƒ†ãƒŠåŒ–

```dockerfile
# Dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .

EXPOSE 3000

CMD ["node", "dist/index.js"]
```

```yaml
# docker-compose.yml
version: '3.8'

services:
  user-service:
    build: ./user-service
    ports:
      - "3001:3000"
    environment:
      - DATABASE_URL=postgresql://...
      - JWT_SECRET=secret
    depends_on:
      - user-db

  product-service:
    build: ./product-service
    ports:
      - "3002:3000"
    depends_on:
      - product-db

  user-db:
    image: postgres:15
    environment:
      - POSTGRES_DB=users
      - POSTGRES_PASSWORD=password
```

### Kubernetes

```yaml
# deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: user-service
spec:
  replicas: 3
  selector:
    matchLabels:
      app: user-service
  template:
    metadata:
      labels:
        app: user-service
    spec:
      containers:
      - name: user-service
        image: user-service:1.0.0
        ports:
        - containerPort: 3000
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: db-secret
              key: url
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"

---
apiVersion: v1
kind: Service
metadata:
  name: user-service
spec:
  selector:
    app: user-service
  ports:
  - port: 80
    targetPort: 3000
```

---

## ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

### åˆ†æ•£ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°

```typescript
// OpenTelemetry
import { trace } from '@opentelemetry/api'

const tracer = trace.getTracer('user-service')

async function getUser(userId: string) {
  const span = tracer.startSpan('getUser')

  try {
    span.setAttribute('userId', userId)

    const user = await db.users.findById(userId)

    span.setStatus({ code: SpanStatusCode.OK })
    return user
  } catch (error) {
    span.setStatus({ code: SpanStatusCode.ERROR, message: error.message })
    throw error
  } finally {
    span.end()
  }
}
```

### ãƒ­ã‚°é›†ç´„

```typescript
// æ§‹é€ åŒ–ãƒ­ã‚°
import pino from 'pino'

const logger = pino({
  level: 'info',
  base: {
    service: 'user-service',
    version: '1.0.0'
  }
})

logger.info({ userId, action: 'login' }, 'User logged in')
```

---

## èª²é¡Œã¨å¯¾ç­–

### ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯éšœå®³

```typescript
// Circuit Breaker
import CircuitBreaker from 'opossum'

const options = {
  timeout: 3000,
  errorThresholdPercentage: 50,
  resetTimeout: 30000
}

const breaker = new CircuitBreaker(callExternalService, options)

breaker.fallback(() => ({ fallback: true }))

breaker.on('open', () => {
  logger.warn('Circuit breaker opened')
})
```

### ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§

```
- Eventual Consistency ã‚’å—ã‘å…¥ã‚Œã‚‹
- Saga ãƒ‘ã‚¿ãƒ¼ãƒ³ã§è£œå„Ÿãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³
- Event Sourcing ã§ã‚¤ãƒ™ãƒ³ãƒˆè¨˜éŒ²
- Outbox ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°ä¿è¨¼
```

---

## å‚è€ƒãƒªãƒ³ã‚¯

- [Microservices.io](https://microservices.io/)
- [Building Microservices - Sam Newman](https://samnewman.io/books/building_microservices/)
