# ポストモーテム: [インシデントタイトル]

> 作成日: YYYY-MM-DD
> 作成者: @username
> レビュー者: @username1, @username2
> インシデント日時: YYYY-MM-DD HH:MM - HH:MM (JST)
> 重要度: SEV-X

---

## TL;DR（要約）

<!-- 1-2段落で簡潔にまとめる -->

**何が起きたか**:
[簡潔な説明]

**影響**:
[ユーザー影響の概要]

**根本原因**:
[技術的な根本原因]

**解決策**:
[実施した対処]

---

## インシデント概要

### 影響

| 項目 | 詳細 |
|------|------|
| **影響を受けたサービス** | API, Web UI, Mobile App |
| **影響を受けたユーザー数** | 約 10,000 ユーザー（全体の15%） |
| **影響範囲** | 全リージョン / 特定リージョン |
| **ダウンタイム** | 1時間22分 |
| **データ損失** | なし / あり（詳細） |
| **ビジネス影響** | 推定損失額、解約数など |

### タイムライン

| 時刻 (JST) | イベント | アクション |
|-----------|---------|-----------|
| 14:23 | インシデント発生 | データベース接続プールが枯渇開始 |
| 14:25 | アラート発火 | PagerDuty が高エラー率を検知 |
| 14:27 | オンコール応答 | @alice がアラートを ACK |
| 14:30 | 調査開始 | ログとメトリクスの確認開始 |
| 14:35 | 根本原因特定 | データベース接続プール設定が不適切と判明 |
| 14:40 | 修正適用 | 接続プール設定を変更 |
| 14:45 | ローリング再起動 | アプリケーションサーバーを順次再起動 |
| 15:00 | 部分復旧 | エラー率が50%低下 |
| 15:30 | 完全復旧確認 | すべてのメトリクスが正常範囲に |
| 15:45 | インシデントクローズ | ステータスページを更新 |

### 検知方法

- [x] 自動アラート（Prometheus）
- [ ] ユーザー報告（サポート問い合わせ）
- [ ] 内部監視ダッシュボード
- [ ] SNS報告

**検知までの時間**: 2分（発生から）

---

## 根本原因分析（Root Cause Analysis）

### 何が起きたか

<!-- 技術的な詳細を記述 -->

```
1. 午前中のマーケティングキャンペーン開始により、通常の3倍のトラフィックが発生
2. アプリケーションサーバーからデータベースへの接続数が急増
3. データベース接続プール設定が max_connections=100 に設定されており、不足
4. 新規接続要求がタイムアウトし、API がエラーを返し始めた
5. 既存の接続も長時間保持されており、プールが解放されなかった
```

### なぜ発生したか（5 Whys）

**問題**: API がエラーを返した

1. **Why?** データベース接続が取得できなかった
   - → 接続プールが枯渇していた

2. **Why?** 接続プールが枯渇した
   - → トラフィックが通常の3倍に増加した

3. **Why?** トラフィック増加に対応できなかった
   - → 接続プール設定が固定値（100）だった

4. **Why?** 接続プール設定が固定値だった
   - → 負荷テストが通常トラフィックの2倍までしか実施していなかった

5. **Why?** 負荷テストが不十分だった
   - → **根本原因**: マーケティングキャンペーンの影響を事前に見積もり、負荷テストに反映するプロセスがなかった

### 寄与要因（Contributing Factors）

- 接続プール設定がハードコードされており、環境変数で調整できなかった
- 接続プール使用率のアラートが設定されていなかった
- マーケティングチームとエンジニアリングチームの連携不足
- ステージング環境では本番トラフィックの10%程度でしかテストしていなかった

---

## 何がうまくいったか（What Went Well）

- ✅ アラートが2分以内に発火し、迅速に検知できた
- ✅ オンコールが5分以内に応答し、調査を開始
- ✅ ランブックが整備されており、診断が迅速に進んだ
- ✅ ローリング再起動により、ダウンタイムを最小化
- ✅ ステータスページでユーザーに適切に情報提供できた

---

## 何が改善できるか（What Didn't Go Well）

- ❌ 接続プール枯渇のアラートがなく、事前に気づけなかった
- ❌ 負荷テストのシナリオが不十分で、今回の状況を想定していなかった
- ❌ マーケティングキャンペーンの事前通知がエンジニアチームになかった
- ❌ 接続プール設定がハードコードされており、即座の調整ができなかった
- ❌ データベース接続プールのメトリクスがダッシュボードになかった

---

## アクションアイテム

### 即座の対応（完了済み）

- [x] 接続プール設定を 100 → 500 に増加 (@alice, 2025-10-27完了)
- [x] アプリケーションサーバーを再起動 (@alice, 2025-10-27完了)

### 短期（1週間以内）

| アクション | 担当者 | 期限 | ステータス | Issue |
|----------|--------|------|-----------|-------|
| 接続プール使用率のアラート追加 | @bob | 2025-11-03 | 進行中 | #1234 |
| 接続プール設定を環境変数化 | @charlie | 2025-11-03 | 未着手 | #1235 |
| データベース接続のメトリクスをダッシュボードに追加 | @bob | 2025-11-01 | 完了 | #1236 |

### 中期（1ヶ月以内）

| アクション | 担当者 | 期限 | ステータス | Issue |
|----------|--------|------|-----------|-------|
| 負荷テストシナリオの見直し（3倍トラフィックを想定） | @dave | 2025-11-27 | 未着手 | #1237 |
| マーケティング施策の事前通知プロセス確立 | @marketing | 2025-11-27 | 未着手 | #1238 |
| 接続プールの自動スケーリング機能の検討 | @charlie | 2025-11-27 | 未着手 | #1239 |

### 長期（3ヶ月以内）

| アクション | 担当者 | 期限 | ステータス | Issue |
|----------|--------|------|-----------|-------|
| データベース接続プーリング戦略の再設計（PgBouncer導入検討） | @infra-team | 2026-01-27 | 未着手 | #1240 |
| Chaos Engineering の定期実施（月次） | @sre-team | 2026-01-27 | 未着手 | #1241 |

---

## 学び（Lessons Learned）

### 技術的な学び

1. **接続プール設定は動的に調整可能にする**
   - ハードコードされた設定値は、緊急時の対応を困難にする
   - 環境変数または Feature Flag で制御すべき

2. **リソース使用率のアラートは必須**
   - CPU, メモリだけでなく、接続プール、ファイルディスクリプタなどのリソースも監視

3. **負荷テストは最悪ケースを想定する**
   - 通常トラフィックの2倍ではなく、3-5倍を想定すべき

### プロセス的な学び

1. **部門間連携の重要性**
   - マーケティング施策は必ずエンジニアリングチームに事前共有
   - 影響の大きい施策は、負荷テストを事前に実施

2. **ランブックの効果**
   - 事前に整備されたランブックにより、診断時間が大幅に短縮された
   - 今後も重要なシナリオのランブックを拡充すべき

---

## 参考資料

### ダッシュボード
- [Grafana - Database Connections](https://grafana.example.com/d/db-connections)
- [Grafana - API Error Rate](https://grafana.example.com/d/api-errors)

### ログ
- [CloudWatch Logs - Application Errors (14:23-15:45)](https://console.aws.amazon.com/cloudwatch/...)

### Slack チャンネル
- [#incident-2025-10-27-api-down](https://example.slack.com/archives/C01234567)

### 関連ドキュメント
- [Database Connection Pool Configuration](https://wiki.example.com/db-pool)
- [Load Testing Runbook](https://wiki.example.com/load-test)

---

## レビューと承認

### レビュアー

- [ ] @engineering-manager - プロセス改善の妥当性
- [ ] @sre-lead - 技術的対応の妥当性
- [ ] @product-manager - ユーザー影響の評価

### レビュー会議

- **日時**: 2025-10-28 15:00-16:00
- **参加者**: @alice, @bob, @charlie, @engineering-manager, @sre-lead
- **議事録**: [リンク]

### 承認

- [ ] Engineering Manager
- [ ] SRE Lead
- [ ] CTO (SEV-1の場合)

---

## テンプレート使用ガイド

### 作成タイミング

- **SEV-1**: 必須、解決後24時間以内にドラフト作成
- **SEV-2**: 必須、解決後1週間以内にドラフト作成
- **SEV-3**: 任意（学びが多い場合は推奨）

### 作成プロセス

1. **ドラフト作成**（IC が担当）
   - タイムラインの整理
   - 技術的詳細の記述

2. **レビュー依頼**
   - 関係者に共有し、フィードバックを収集

3. **レビュー会議**
   - チーム全体でレビュー
   - アクションアイテムの優先順位決定

4. **最終化と共有**
   - 全社に共有（Slack, Wiki）
   - アクションアイテムを Issue/Jira に起票

### ポストモーテムの原則

1. **Blameless（非難しない）**
   - 個人を責めるのではなく、システムとプロセスの改善に焦点

2. **Actionable（実行可能）**
   - 具体的なアクションアイテムを明確にする
   - 担当者と期限を設定

3. **Transparent（透明性）**
   - 全社に公開し、組織全体で学ぶ

4. **Timely（タイムリー）**
   - 記憶が新しいうちに作成

---

## 関連ガイド

### インシデント対応
- [インシデント対応ガイド](./incident_response.md) - インシデント対応の全体プロセス

### ランブック
- [ランブックテンプレート](../runbook/runbook_template.md) - 対応手順の標準化

### モニタリング
- [モニタリングガイド](../monitoring/monitoring_guide.md) - システム監視の基礎
- [アラート設計ガイド](../monitoring/alerting_guide.md) - 効果的なアラート設計
